---
# Tâches pour le rôle vintage_story

- name: Création de l'utilisateur pour Vintage Story
  ansible.builtin.user:
    name: '{{ vintage_story_user }}'
    create_home: true
    shell: /bin/bash
    system: false
  tags:
    - setup
    - user

- name: Création du répertoire .ssh pour l'utilisateur
  ansible.builtin.file:
    path: '{{ vintage_story_home }}/.ssh'
    state: directory
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0700'
  tags:
    - setup
    - user
    - ssh

- name: Détermination du chemin de la clé publique SSH
  ansible.builtin.set_fact:
    vintage_story_ssh_public_key_path: '{{ ansible_ssh_private_key_file }}.pub'
  tags:
    - setup
    - user
    - ssh

- name: Vérification de l'existence de la clé publique SSH
  ansible.builtin.stat:
    path: '{{ vintage_story_ssh_public_key_path }}'
  register: vintage_story_ssh_public_key_stat
  delegate_to: localhost
  become: false
  tags:
    - setup
    - user
    - ssh

- name: Ajout de la clé SSH publique aux authorized_keys
  ansible.posix.authorized_key:
    user: '{{ vintage_story_user }}'
    state: present
    key: '{{ lookup("file", vintage_story_ssh_public_key_path) }}'
    comment: '{{ lookup("pipe", "whoami") }}@{{ lookup("pipe", "hostname") }}'
  when: vintage_story_ssh_public_key_stat.stat.exists
  tags:
    - setup
    - user
    - ssh

- name: Ajout des alias utiles dans .bashrc
  ansible.builtin.blockinfile:
    path: '{{ vintage_story_home }}/.bashrc'
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0644'
    create: true
    block: |
      # Grep with colors
      export GREP_COLOR='mt=31'
      alias grep='grep --color=auto'

      ## Shell
      alias ll='ls -hal'
      alias la='ls -A'
      alias lh='ls -ah'
      alias l='ls -CF'
      alias lll='ls -lh | less'
      alias llt='ls -altF'
      alias sh-755='find -name "*.sh" | xargs chmod 755'
      alias uuid='uuidgen | tr "[:upper:]" "[:lower:]"'

      ## NPM
      alias nr='npm run'
      alias nru='npm run update-dependencies'
    marker: '# {mark} ANSIBLE MANAGED BLOCK - General Aliases'
  tags:
    - setup
    - config

- name: Téléchargement de la clé GPG pour Microsoft
  ansible.builtin.get_url:
    url: https://packages.microsoft.com/keys/microsoft.asc
    dest: /tmp/microsoft.asc
    mode: '0644'
  tags:
    - setup
    - dependencies

- name: Ajout de la clé GPG pour Microsoft
  ansible.builtin.shell: |
    gpg -o /usr/share/keyrings/microsoft-prod.gpg --dearmor /tmp/microsoft.asc
  args:
    creates: /usr/share/keyrings/microsoft-prod.gpg
  tags:
    - setup
    - dependencies

- name: Ajout du dépôt Microsoft à APT
  ansible.builtin.apt_repository:
    filename: microsoft-prod
    # Create file to /etc/apt/sources.list.d/microsoft-prod.list
    repo: deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/{{ ansible_distribution | lower }}/{{ ansible_distribution_major_version }}/prod {{ ansible_distribution_release }} main
    state: present
    update_cache: true
  tags:
    - setup
    - dependencies

- name: Installation des dépendances et runtime .NET 8
  ansible.builtin.apt:
    name:
      - dotnet-runtime-8.0 # Runtime .NET 8 pour Vintage Story
      - libopenal-dev # OpenAL pour le son
      - screen
      - unzip
    state: present
  tags:
    - setup
    - packages

- name: Création du répertoire serveur
  ansible.builtin.file:
    path: '{{ vintage_story_server_dir }}'
    state: directory
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0755'
  tags:
    - setup
    - directories

- name: Création du répertoire de données Vintage Story
  ansible.builtin.file:
    path: '{{ vintage_story_world_dir }}'
    state: directory
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0755'
  tags:
    - setup
    - directories

- name: Vérification du fichier de version
  ansible.builtin.stat:
    path: '{{ vintage_story_server_dir }}/.vs_version'
  register: vs_version_file_stat
  tags:
    - server
    - download

- name: Lecture de la version installée
  ansible.builtin.slurp:
    src: '{{ vintage_story_server_dir }}/.vs_version'
  register: vs_installed_version_raw
  when: vs_version_file_stat.stat.exists
  tags:
    - server
    - download

- name: Vérification de la nécessité de mise à jour
  ansible.builtin.debug:
    msg: Mise à jour du serveur Vintage Story vers la version {{ vintage_story_version }}
  when: >
    not vs_version_file_stat.stat.exists or
    (vs_installed_version_raw.content | b64decode | trim) != vintage_story_version
  notify:
    - Téléchargement du serveur Vintage Story
    - Extraction du serveur
    - Configuration des permissions exécutables
    - Création du fichier de version
    - Nettoyage des fichiers temporaires
  changed_when: >
    not vs_version_file_stat.stat.exists or
    (vs_installed_version_raw.content | b64decode | trim) != vintage_story_version
  tags:
    - server
    - download

- name: Exécution immédiate des handlers d'installation
  ansible.builtin.meta: flush_handlers
  tags:
    - server
    - download

- name: Génération du fichier de configuration avancée servermagicnumbers
  ansible.builtin.template:
    src: servermagicnumbers.json.j2
    dest: '{{ vintage_story_world_dir }}/servermagicnumbers.json'
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0644'
  tags:
    - server
    - config

- name: Génération du fichier de configuration principal du serveur
  ansible.builtin.template:
    src: serverconfig.json.j2
    dest: '{{ vintage_story_world_dir }}/serverconfig.json'
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0644'
    backup: true
  tags:
    - server
    - config

- name: Configuration du pare-feu pour Vintage Story (UDP)
  community.general.ufw:
    rule: allow
    port: '{{ vintage_story_port }}'
    proto: udp
    comment: Vintage Story Server UDP
  tags:
    - server
    - config
    - firewall

- name: Configuration du pare-feu pour Vintage Story (TCP)
  community.general.ufw:
    rule: allow
    port: '{{ vintage_story_port }}'
    proto: tcp
    comment: Vintage Story Server TCP
  tags:
    - server
    - config
    - firewall

- name: Configuration du script server.sh officiel
  ansible.builtin.lineinfile:
    path: '{{ vintage_story_server_dir }}/server.sh'
    regexp: ^USERNAME=.*
    line: USERNAME='{{ vintage_story_user }}'
    backup: true
  tags:
    - server
    - config
    - scripts

- name: Configuration du chemin dans server.sh
  ansible.builtin.lineinfile:
    path: '{{ vintage_story_server_dir }}/server.sh'
    regexp: ^VSPATH=.*
    line: VSPATH='{{ vintage_story_server_dir }}'
    backup: true
  tags:
    - server
    - config
    - scripts

- name: Configuration du chemin de données dans server.sh
  ansible.builtin.lineinfile:
    path: '{{ vintage_story_server_dir }}/server.sh'
    regexp: ^DATAPATH=.*
    line: DATAPATH='{{ vintage_story_world_dir }}'
    backup: true
  tags:
    - server
    - config
    - scripts

- name: Sauvegarde du fichier de configuration runtime .NET original
  ansible.builtin.copy:
    src: '{{ vintage_story_server_dir }}/VintagestoryServer.runtimeconfig.json'
    dest: '{{ vintage_story_server_dir }}/VintagestoryServer.runtimeconfig.json.backup'
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0644'
    remote_src: true
    force: false # Ne pas écraser si la sauvegarde existe déjà
  tags:
    - server
    - config
    - scripts

- name: Création du fichier de configuration runtime .NET
  ansible.builtin.copy:
    src: VintagestoryServer.runtimeconfig.json
    dest: '{{ vintage_story_server_dir }}/VintagestoryServer.runtimeconfig.json'
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0644'
    backup: true
  tags:
    - server
    - config
    - scripts

- name: Création du service systemd
  ansible.builtin.template:
    src: vintage_story.service.j2
    dest: /etc/systemd/system/vintage-story.service
    mode: '0644'
  notify: Rechargement de systemd
  tags:
    - server
    - config
    - service

- name: Configuration sudo pour permettre à vintagestory de gérer son service
  ansible.builtin.copy:
    dest: /etc/sudoers.d/vintage-story
    mode: '0440'
    owner: root
    group: root
    content: |
      # Permet à l'utilisateur vintagestory de gérer son propre service
      {{ vintage_story_user }} ALL=(ALL) NOPASSWD: /bin/systemctl start vintage-story, /bin/systemctl stop vintage-story, /bin/systemctl restart vintage-story, /bin/systemctl status vintage-story, /bin/systemctl reload vintage-story
    validate: visudo -cf %s
  tags:
    - server
    - config
    - service

- name: Ajout des alias de gestion du serveur dans .bashrc
  ansible.builtin.blockinfile:
    path: '{{ vintage_story_home }}/.bashrc'
    owner: '{{ vintage_story_user }}'
    group: '{{ vintage_story_user }}'
    mode: '0644'
    create: true
    block: |
      # Variables d'environnement
      export GAME_DATA_DIR='{{ vintage_story_world_dir }}'

      # Alias pour la gestion du serveur Vintage Story
      alias server-restart='sudo systemctl restart vintage-story'
      alias server-status='sudo systemctl status vintage-story'
      alias server-stop='sudo systemctl stop vintage-story'
      alias server-start='sudo systemctl start vintage-story'
      alias server-command='{{ vintage_story_server_dir }}/server.sh command'
      alias server-logs='cat {{ vintage_story_world_dir }}/Logs/server-main.log'
    marker: '# {mark} ANSIBLE MANAGED BLOCK - Vintage Story Server'
  tags:
    - server
    - config
    - service

- name: Configuration du démarrage automatique du serveur
  ansible.builtin.cron:
    name: '{{ item.name }}'
    minute: '{{ item.minute }}'
    hour: '{{ item.hour }}'
    day: '*'
    month: '*'
    weekday: '{{ item.weekday }}'
    user: root
    job: '{{ item.job }}'
  loop:
    - name: Démarrage serveur Vintage Story - Semaine à 17h
      minute: '0'
      hour: '17'
      weekday: 1-5
      job: /bin/systemctl start vintage-story
    - name: Démarrage serveur Vintage Story - Weekend à 8h
      minute: '0'
      hour: '8'
      weekday: 6,0
      job: /bin/systemctl start vintage-story
    - name: Arrêt serveur Vintage Story - Tous les jours à 3h
      minute: '0'
      hour: '3'
      weekday: '*'
      job: /bin/systemctl stop vintage-story
  tags:
    - server
    - config
    - cron

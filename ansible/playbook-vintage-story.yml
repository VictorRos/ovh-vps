---
# Prérequis : Fichier de variables sensibles ansible/vars/production.yml
#
# Commande pour exécuter le playbook
# ansible-playbook --extra-vars @ansible/vars/production.yml -i ansible/inventory.yml ansible/playbook-vintage-story.yml
#
# Simulation complète sans modifications
# ansible-playbook --extra-vars @ansible/vars/production.yml -i ansible/inventory.yml ansible/playbook-vintage-story.yml --check
#
# Avec plus de détails sur ce qui serait changé
# ansible-playbook --extra-vars @ansible/vars/production.yml -i ansible/inventory.yml ansible/playbook-vintage-story.yml --check --diff
#
# === EXÉCUTION PARTIELLE ===
# Tags disponibles : setup, user, dependencies, packages, directories, server, download, install, config, firewall, scripts, service, cleanup
#
# Installer seulement les dépendances :
# ansible-playbook --extra-vars @ansible/vars/production.yml -i ansible/inventory.yml ansible/playbook-vintage-story.yml --tags "setup"
#
# Installer seulement le serveur Vintage Story :
# ansible-playbook --extra-vars @ansible/vars/production.yml -i ansible/inventory.yml ansible/playbook-vintage-story.yml --tags "server"
#
# Installer seulement le serveur Vintage Story sans les scripts et le service :
# ansible-playbook --extra-vars @ansible/vars/production.yml -i ansible/inventory.yml ansible/playbook-vintage-story.yml --tags "server" --skip-tags "scripts,service"
#
# Seulement firewall et service :
# ansible-playbook --extra-vars @ansible/vars/production.yml -i ansible/inventory.yml ansible/playbook-vintage-story.yml --tags "firewall,service"
#
# Lister toutes les tâches avec leurs tags :
# ansible-playbook --extra-vars @ansible/vars/production.yml -i ansible/inventory.yml ansible/playbook-vintage-story.yml --list-tags
#
- name: Installation et configuration de Vintage Story
  hosts: vintage_story
  become: true
  vars:
    # Variables techniques pour Vintage Story (non configurables)
    vs_user: vintagestory
    vs_home: /home/{{ vs_user }}
    vs_server_dir: '{{ vs_home }}/server'
    vs_world_dir: /var/vintagestory/data
    vs_version: 1.21.6 # Version actuelle de Vintage Story

    # Note: Les variables de configuration du serveur sont dans group_vars/vintage_story.yml

  tasks:
    - name: Création de l'utilisateur pour Vintage Story
      ansible.builtin.user:
        name: '{{ vs_user }}'
        create_home: true
        shell: /bin/bash
        system: false
      tags:
        - setup
        - user

    - name: Ajout des alias utiles dans .bashrc
      ansible.builtin.blockinfile:
        path: '{{ vs_home }}/.bashrc'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0644'
        create: true
        block: |
          # Grep with colors
          export GREP_COLOR='mt=31'
          alias grep='grep --color=auto'

          ## Shell
          alias ll='ls -hal'
          alias la='ls -A'
          alias lh='ls -ah'
          alias l='ls -CF'
          alias lll='ls -lh | less'
          alias llt='ls -altF'
          alias sh-755='find -name "*.sh" | xargs chmod 755'
          alias uuid='uuidgen | tr "[:upper:]" "[:lower:]"'

          ## NPM
          alias nr='npm run'
          alias nru='npm run update-dependencies'
        marker: '# {mark} ANSIBLE MANAGED BLOCK - General Aliases'
      tags:
        - setup
        - config

    - name: Téléchargement de la clé GPG pour Microsoft
      ansible.builtin.get_url:
        url: https://packages.microsoft.com/keys/microsoft.asc
        dest: /tmp/microsoft.asc
        mode: '0644'
      tags:
        - setup
        - dependencies

    - name: Ajout de la clé GPG pour Microsoft
      ansible.builtin.shell: |
        gpg -o /usr/share/keyrings/microsoft-prod.gpg --dearmor /tmp/microsoft.asc
      args:
        creates: /usr/share/keyrings/microsoft-prod.gpg
      tags:
        - setup
        - dependencies

    - name: Ajout du dépôt Microsoft à APT
      ansible.builtin.apt_repository:
        filename: microsoft-prod
        # Create file to /etc/apt/sources.list.d/microsoft-prod.list
        repo: deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/{{ ansible_distribution | lower }}/{{ ansible_distribution_major_version }}/prod {{ ansible_distribution_release }} main
        state: present
        update_cache: true
      tags:
        - setup
        - dependencies

    - name: Installation des dépendances et runtime .NET 8
      ansible.builtin.apt:
        name:
          - dotnet-runtime-8.0 # Runtime .NET 8 pour Vintage Story
          - libopenal-dev # OpenAL pour le son
          - screen
          - unzip
        state: present
      tags:
        - setup
        - packages

    - name: Création du répertoire serveur
      ansible.builtin.file:
        path: '{{ vs_server_dir }}'
        state: directory
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0755'
      tags:
        - setup
        - directories

    - name: Création du répertoire de données Vintage Story
      ansible.builtin.file:
        path: '{{ vs_world_dir }}'
        state: directory
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0755'
      tags:
        - setup
        - directories

    - name: Vérification du fichier de version
      ansible.builtin.stat:
        path: '{{ vs_server_dir }}/.vs_version'
      register: vs_version_file_stat
      tags:
        - server
        - download

    - name: Lecture de la version installée
      ansible.builtin.slurp:
        src: '{{ vs_server_dir }}/.vs_version'
      register: vs_installed_version_raw
      when: vs_version_file_stat.stat.exists
      tags:
        - server
        - download

    - name: Vérification de la nécessité de mise à jour
      ansible.builtin.debug:
        msg: Mise à jour du serveur Vintage Story vers la version {{ vs_version }}
      when: >
        not vs_version_file_stat.stat.exists or
        (vs_installed_version_raw.content | b64decode | trim) != vs_version
      notify:
        - Téléchargement du serveur Vintage Story
        - Extraction du serveur
        - Configuration des permissions exécutables
        - Création du fichier de version
        - Nettoyage des fichiers temporaires
      changed_when: >
        not vs_version_file_stat.stat.exists or
        (vs_installed_version_raw.content | b64decode | trim) != vs_version
      tags:
        - server
        - download

    - name: Exécution immédiate des handlers d'installation
      ansible.builtin.meta: flush_handlers
      tags:
        - server
        - download

    - name: Copie du fichier de configuration avancée
      ansible.builtin.copy:
        src: files/vintage-story/servermagicnumbers.json
        dest: '{{ vs_world_dir }}/servermagicnumbers.json'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0644'
      tags:
        - server
        - config

    - name: Génération du fichier de configuration principal du serveur
      ansible.builtin.template:
        src: templates/vintage-story/serverconfig.json.j2
        dest: '{{ vs_world_dir }}/serverconfig.json'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0644'
        backup: true
      tags:
        - server
        - config

    - name: Configuration du pare-feu pour Vintage Story (UDP)
      community.general.ufw:
        rule: allow
        port: '{{ vs_port }}'
        proto: udp
        comment: Vintage Story Server UDP
      tags:
        - server
        - config
        - firewall

    - name: Configuration du pare-feu pour Vintage Story (TCP)
      community.general.ufw:
        rule: allow
        port: '{{ vs_port }}'
        proto: tcp
        comment: Vintage Story Server TCP
      tags:
        - server
        - config
        - firewall

    - name: Configuration du script server.sh officiel
      ansible.builtin.lineinfile:
        path: '{{ vs_server_dir }}/server.sh'
        regexp: ^USERNAME=.*
        line: USERNAME='{{ vs_user }}'
        backup: true
      tags:
        - server
        - config
        - scripts

    - name: Configuration du chemin dans server.sh
      ansible.builtin.lineinfile:
        path: '{{ vs_server_dir }}/server.sh'
        regexp: ^VSPATH=.*
        line: VSPATH='{{ vs_server_dir }}'
        backup: true
      tags:
        - server
        - config
        - scripts

    - name: Configuration du chemin de données dans server.sh
      ansible.builtin.lineinfile:
        path: '{{ vs_server_dir }}/server.sh'
        regexp: ^DATAPATH=.*
        line: DATAPATH='{{ vs_world_dir }}'
        backup: true
      tags:
        - server
        - config
        - scripts

    - name: Sauvegarde du fichier de configuration runtime .NET original
      ansible.builtin.copy:
        src: '{{ vs_server_dir }}/VintagestoryServer.runtimeconfig.json'
        dest: '{{ vs_server_dir }}/VintagestoryServer.runtimeconfig.json.backup'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0644'
        remote_src: true
        force: false # Ne pas écraser si la sauvegarde existe déjà
      tags:
        - server
        - config
        - scripts

    - name: Création du fichier de configuration runtime .NET
      ansible.builtin.copy:
        src: files/vintage-story/VintagestoryServer.runtimeconfig.json
        dest: '{{ vs_server_dir }}/VintagestoryServer.runtimeconfig.json'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0644'
        backup: true
      tags:
        - server
        - config
        - scripts

    - name: Création du service systemd
      ansible.builtin.copy:
        dest: /etc/systemd/system/vintage-story.service
        mode: '0644'
        content: |
          [Unit]
          Description=Vintage Story Server
          After=network.target

          [Service]
          Type=forking
          User={{ vs_user }}
          Group={{ vs_user }}
          WorkingDirectory={{ vs_server_dir }}
          ExecStart={{ vs_server_dir }}/server.sh start
          ExecStop={{ vs_server_dir }}/server.sh stop
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target
      notify: Rechargement de systemd
      tags:
        - server
        - config
        - service

    - name: Configuration sudo pour permettre à vintagestory de gérer son service
      ansible.builtin.copy:
        dest: /etc/sudoers.d/vintage-story
        mode: '0440'
        owner: root
        group: root
        content: |
          # Permet à l'utilisateur vintagestory de gérer son propre service
          {{ vs_user }} ALL=(ALL) NOPASSWD: /bin/systemctl start vintage-story, /bin/systemctl stop vintage-story, /bin/systemctl restart vintage-story, /bin/systemctl status vintage-story, /bin/systemctl reload vintage-story
        validate: visudo -cf %s
      tags:
        - server
        - config
        - service

    - name: Ajout des alias de gestion du serveur dans .bashrc
      ansible.builtin.blockinfile:
        path: '{{ vs_home }}/.bashrc'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0644'
        create: true
        block: |
          # Alias pour la gestion du serveur Vintage Story
          alias server-restart='sudo systemctl restart vintage-story'
          alias server-status='sudo systemctl status vintage-story'
          alias server-stop='sudo systemctl stop vintage-story'
          alias server-start='sudo systemctl start vintage-story'
          alias server-command='{{ vs_server_dir }}/server.sh command'
          alias server-logs='cat {{ vs_world_dir }}/Logs/server-main.log'
        marker: '# {mark} ANSIBLE MANAGED BLOCK - Vintage Story Server'
      tags:
        - server
        - config
        - service

    - name: Configuration du démarrage automatique du serveur
      ansible.builtin.cron:
        name: '{{ item.name }}'
        minute: '{{ item.minute }}'
        hour: '{{ item.hour }}'
        day: '*'
        month: '*'
        weekday: '{{ item.weekday }}'
        user: root
        job: '{{ item.job }}'
      loop:
        - name: Démarrage serveur Vintage Story - Semaine à 17h
          minute: '0'
          hour: '17'
          weekday: 1-5
          job: /bin/systemctl start vintage-story
        - name: Démarrage serveur Vintage Story - Weekend à 8h
          minute: '0'
          hour: '8'
          weekday: 6,0
          job: /bin/systemctl start vintage-story
        - name: Arrêt serveur Vintage Story - Tous les jours à 3h
          minute: '0'
          hour: '3'
          weekday: '*'
          job: /bin/systemctl stop vintage-story
      tags:
        - server
        - config
        - cron

  handlers:
    - name: Téléchargement du serveur Vintage Story
      ansible.builtin.get_url:
        url: https://cdn.vintagestory.at/gamefiles/stable/vs_server_{{ ansible_system | lower }}-{{ 'x64' if ansible_architecture == 'x86_64' else ansible_architecture }}_{{ vs_version }}.tar.gz
        dest: /tmp/vs_server.tar.gz
        mode: '0644'

    - name: Extraction du serveur
      ansible.builtin.unarchive:
        src: /tmp/vs_server.tar.gz
        dest: '{{ vs_server_dir }}'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        remote_src: true

    - name: Configuration des permissions exécutables
      ansible.builtin.file:
        path: '{{ vs_server_dir }}/{{ item }}'
        mode: '0755'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
      loop:
        - VintagestoryServer
        - server.sh

    - name: Création du fichier de version
      ansible.builtin.copy:
        content: '{{ vs_version }}'
        dest: '{{ vs_server_dir }}/.vs_version'
        owner: '{{ vs_user }}'
        group: '{{ vs_user }}'
        mode: '0644'

    - name: Nettoyage des fichiers temporaires
      ansible.builtin.file:
        path: /tmp/vs_server.tar.gz
        state: absent

    - name: Rechargement de systemd
      ansible.builtin.systemd:
        daemon_reload: true
